<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.market.mapper.randomMapper">

	<insert id="rRegist">
		insert into random(ran_price, ran_endTime, ran_sellerId, ran_pic, ran_maxPp, ran_title, ran_content, ran_bidPrice, ran_buyerId)
		values(#{ran_price}, #{ran_endTime}, #{ran_sellerId}, #{ran_pic}, #{ran_maxPp}, #{ran_title}, #{ran_content}, #{ran_bidPrice}, #{ran_buyerId} )
	</insert>
	
	<select id="nowBest" resultType="com.market.domain.RandomVO">
		select * from random
		where ran_num = (select ran_num
						from random
						group by ran_num
                		having ran_status = 0
						order by count(ran_num) desc
                		limit 1)
		order by ran_maxPp desc
		limit 1;
	</select>

	<select id="rList" resultType="com.market.domain.RandomVO">
		select A.*, count(ran_num)-1 as count
		from (select * from random order by ran_maxPp desc limit 0, 10) A
		where A.ran_status = 0
		group by A.ran_num
		order by A.ran_num desc;
	</select>
	
	<select id="rDetail" resultType="com.market.domain.RandomVO">
		select * from random
		where ran_num = #{ran_num} and ran_sellerId is not null
	</select>
	
	<select id="countP" resultType="int">
		select count(ran_num)-1 from random
		where ran_num = #{ran_num}
	</select>

	<select id="getMPay" resultType="int">
		select member_pay from member where member_id = #{member_id}
	</select>
	
	<insert id="rBid">
		insert into random(ran_num, ran_buyerId, ran_bidPrice, ran_price, ran_title)
		values(#{ran_num}, #{ran_buyerId}, #{ran_bidPrice}, #{ran_price}, #{ran_title})
	</insert>
	
	<update id="minusPay">
		update member set member_pay = member_pay - #{mPay} 
		where member_id = #{id}
	</update>
	
	<select id="selectBuyer" resultType="String">
		select ran_buyerId
		from random where ran_num = #{ran_num}
	</select>
	
	<select id="selectTrade" resultType="String">
		select buy_mem_id from trade
		where type_div = "ran" and ran_num = #{ran_num}
	</select>
	
	<update id="updateRan">
		update random set ran_status = 1
		where ran_num = #{ran_num}
	</update>
	
	<select id="selectWinner" resultType="com.market.domain.RandomVO">
		select * from random
		where ran_num = #{ran_num} and ran_sellerId is null
		order by rand()
		limit 1;
	</select>
	
	<insert id="insertTrade">
		insert into trade(buy_mem_id, sell_mem_id, prod_sell_date, type_div, product_title, ran_num)
		values(#{ran_buyerId}, #{ran_sellerId}, now(), 'ran', #{ran_title}, #{ran_num})
	</insert>
	
	<update id="plusPay">
		update member set member_pay = member_pay + #{ran_price}
		where member_id = #{ran_sellerId}
	</update>
	

</mapper>

















